<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
    #my_html {
    position: absolute;
    top: 60px;
    right: 600px;
    bottom: 0;
    left: 0;
    }
    #my_control {
    position: absolute;
    top: 52px;
    right: 0px;
    bottom: 0;
    width: 600px;
    padding: 8px;
    }
    #my_html_hidden {
    display: none;
    }

    .ace_gutter-cell.ace_breakpoint{ 
        border-radius: 20px 0px 0px 20px; 
        background:#ff5555;
    }

    .errorHighlight{
      position:absolute;
      background-color:rgb(255, 55, 55, 0.2);
    }
    </style>

    <title>Gabuino</title>
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://rawgithub.com/ajaxorg/ace-builds/master/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://rawgithub.com/ajaxorg/ace-builds/master/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script src="compiler.js"></script>
    <script src="editor.js"></script>
    <script src="serial.js"></script>
    <script src="comm.js"></script>
    <script src="bios.js"></script>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <script src="binary-parser/context.js"></script>
    <script src="binary-parser/binary_parser.js"></script>
    <script src="parseelf.js"></script>
    <script src="examples.js"></script>
    <script src="debugger.js"></script>
    <script src="dsym_os.js"></script>
    <script src="dsym_gabuino.js"></script>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#"><img src="gabuino.png" height=32></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Examples
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="_examples">
        </div>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          File
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="#">Save</a>
          <a class="dropdown-item" href="#">Save as...</a>
          <a class="dropdown-item" href="#">Delete</a>
          <div class="dropdown-divider"></div>
          <a><h6 class="dropdown-header">Stored programs</h6></a>
          <a class="dropdown-item" href="#">User program 1</a>
          <a class="dropdown-item" href="#">User program 2</a>
        </div>
      </li>


      <button class="btn btn-sm btn-outline-secondary mr-2" type="button" id="_connect">Connected</button>
      <a class="navbar-text mr-2" id="_connectText">Device not found</a>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <button class="btn btn-outline-success mr-1 my-2 my-sm-0" type="button" id="_run">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="3 3 12 12">
  <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>
</svg>
Run</button>

      <button class="btn btn-success mr-1 my-2 my-sm-0" type="button" id="_stop">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop" viewBox="3 3 12 12">
  <path d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z"/>
</svg>
Stop</button>
    </form>
  </div>
</nav>



<div id="my_control">

<div class="card">
<article class="card-body">
<h4 class="card-title mb-4 mt-1">Compilation</h4>
  <div class="form-group" id="_compilationText">
  </div>
</article>
</div>

<br>

<div class="card">
<article class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-4 mt-1">Debug console</h4>
        <div>
            <button type="button" class="btn btn-outline-success">Screenshot</button>
            <button type="button" class="btn btn-outline-success">Clear</button>
<!--            <button type="button" class="btn btn-outline-success">Pause</button>-->
        </div>
    </div>

  <div class="form-group" id="_debugText" style="white-space: pre-wrap; "></div>
</article>
</div>
<br>

<div class="card">
<article class="card-body">
<h4 class="card-title mb-4 mt-1">Testing</h4>
  <input type=button id="frame" value="Start debugging" onclick="debug()">
  <input type=button id="frame" value="frame" onclick="frame()">
  <input type=button id="screenshot" value="screenshot" onclick="screenshot()">
</article>
</div>


</div>


<script>
$('#_connect').on('click', function(event) {
//  event.preventDefault(); // To prevent following the link (optional)
  COMM.doConnect();
});

$('#_run').on('click', function(event) {
  var newCode = html_editor.getValue();

  if (typeof(lastCode) != "undefined" && lastCode == newCode)
  {
    // reset bss!
    $("#_debugText").text("");
    run();
    return;
  }
  lastCode = newCode;


  var tick0 = (new Date).getTime();
  var tick1, tick2, tick3;

  compile()
  .then( (elf) => {
    tick1 = (new Date).getTime();
    $("#_compilationText").text("Compilation took " + (tick1-tick0) + "ms.\n");  
    return elf;
  })
  .then( elf => processElf(elf))
  .then( (stats) => {
    tick2 = (new Date).getTime();
    $("#_compilationText").append("Processing took " + (tick2-tick1) + "ms.\n");  
    $("#_debugText").text("");
  })
  .then( () => resolveImports())
  .then( () => {
    tick3 = (new Date).getTime();
    $("#_compilationText").append("Resolving relocations took " + (tick3-tick2) + "ms.\n");  
    $("#_debugText").text("");
  })
  .then( () => flash() )
  .then( () =>
  {
    tick4 = (new Date).getTime();
    $("#_compilationText").append("Flashing took " + (tick4-tick3) + "ms.\n");  
    $("#_compilationText").append("Application size " + globalBlob.length + " bytes\n");  
    return run();
  })
  .catch( stderr =>
  {
    $("#_compilationText").text("Failed: <pre>"+stderr.split("<stdin>:").join("")+"</pre>");  
  });

});

$('#_stop').on('click', function(event) {
  stop();
});

COMM.setDisconnected = () => { 
  $("#_connect").text("Connect"); 
  $("#_connectText").text("Disconnected"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};
COMM.setConnected = () => { 
  $("#_connect").text("Disconnect"); 
  $("#_connectText").text("Connected"); 
  $("#_connect").removeClass("btn-secondary").addClass("btn-outline-secondary");
};
COMM.setConnecting = () => { 
  $("#_connect").text("Connecting..."); 
  $("#_connectText").text(""); 
  $("#_connect").removeClass("btn-secondary").addClass("btn-outline-secondary");
};
COMM.setConnectFailed = (err) => { 
  $("#_connect").text("Connect"); 
  $("#_connectText").text(err ? err : "Connection failed"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};
COMM.setNoDevices = () => {
  $("#_connect").text("Connect"); 
  $("#_connectText").text("Not connected"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};

function _DBGPRINT(msg)
{
document.getElementById("_debugText").innerHTML += msg;
//  $("#_debugText").append(msg);
}

function _DBGEVENT(e)
{
  console.log("Program finished: "+e);
//  $("#_debugText").append();
}


for (var i in examples)
{
  $("#_examples").append('<a class="dropdown-item" href="#">'+i+'</a>');
}

var elements = $("#_examples").children("a"); //.dropdown-item");

for (var i=0; i<elements.length; i++)
{
  elements[i].addEventListener('click', (event) => {
    html_editor.setValue(examples[event.target.innerText])
//    alert(`Clicked ${event.target.innerText}!`);
  });
};
</script>


<div id="my_html">
</div>

<xmp id="my_html_hidden">#include <library.h>

using namespace BIOS;

typedef int fix16_t;
void drawline_aa(fix16_t fx1, fix16_t fy1, fix16_t fx2, fix16_t fy2, int color);

int main(void)
{
    int x = 100, y = 100, c = 0;
    KEY::EKey key;
    while ((key = KEY::GetKey()) != KEY::EKey::Escape)
    {
        int x1 = rand() % LCD::Width;
        int y1 = 16+(rand() % (LCD::Height-32));
        int c = rand() & 0xffff;
        drawline_aa(x*256, y*256, x1*256, y1*256, c);
        x = x1;
        y = y1;

        if ((c++ % 1000) == 0)
            DBG::Print("<b>%d</b> lines, ", c);
    }
    
    return 0;
}




// https://github.com/PetteriAimonen/QuadPawn/blob/master/Runtime/drawing.c

/* Antialiased line drawing */

// Alpha-blend two colors together. Alpha is 0 to 255.
// The ratios have been biased a bit to make the result look
// better on a cheap TFT.
int blend(int fg, int bg, int alpha)
{
    int fg_per_2 = (fg & 0xF7DE) >> 1;
    int fg_per_4 = (fg & 0xE79C) >> 2;
    int fg_per_8 = (fg & 0xC718) >> 3;
    
    int bg_per_2 = (bg & 0xF7DE) >> 1;
    int bg_per_4 = (bg & 0xE79C) >> 2;
    int bg_per_8 = (bg & 0xC718) >> 3;
    
    if (alpha > 224)
        return fg; // 100% blend
    else if (alpha > 192)
        return (fg - fg_per_8 + bg_per_8); // 88% blend
    else if (alpha > 128)
        return (fg - fg_per_4 + bg_per_4); // 75% blend
    else if (alpha > 64)
        return (fg_per_2 + bg_per_2); // 50% blend
    else if (alpha > 32)
        return (fg_per_4 + bg - bg_per_4); // 25% blend
    else
        return bg; // 0% blend
}


// Draws antialiased lines
// Xiaolin Wu's algorithm, using x/256 fixed point values
void drawline_aa(fix16_t x1, fix16_t y1, fix16_t x2, fix16_t y2, int color)
{
    bool reverse_xy = false;
    
    auto swap = [](int *x, int *y) {
        int temp = *x;
        *x = *y;
        *y = temp;
    };
    
    // plot the pixel at (x, y) with brightness c
    auto plot = [&](int x, int y, int c) {
        if (reverse_xy)
            swap(&x, &y);
        
        uint16_t oldcolor = BIOS::LCD::GetPixel(x >> 8, y >> 8);
        BIOS::LCD::PutPixel(x >> 8, y >> 8, blend(color, oldcolor, c));
    };
    
    // Integer part of x
    auto ipart = [](int x) -> int {
        return x & (~0xFF);
    };
    
    auto round = [&](int x) -> int {
        return ipart(x + 128);
    };
    
    // Fractional part of x
    auto fpart = [](int x) -> int {
        return x & 0xFF;
    };
    
    // Remaining fractional part of x
    auto rfpart = [&](int x) -> int {
        return 256 - fpart(x);
    };

    int dx = x2 - x1;
    int dy = y2 - y1;
    if (abs(dx) < abs(dy))
    {
        swap(&x1, &y1);
        swap(&x2, &y2);
        swap(&dx, &dy);
        reverse_xy = true;
    }
    
    if (x2 < x1)
    {
        swap(&x1, &x2);
        swap(&y1, &y2);
    }
    
    int gradient = dy * 256 / dx;
    
    // handle first endpoint
    int xend = round(x1);
    int yend = y1 + gradient * (xend - x1) / 256;
    int xgap = rfpart(x1 + 128);
    int xpxl1 = xend;  // this will be used in the main loop
    int ypxl1 = ipart(yend);
    plot(xpxl1, ypxl1, rfpart(yend) * xgap / 256);
    plot(xpxl1, ypxl1 + 256, fpart(yend) * xgap / 256);
    int intery = yend + gradient; // first y-intersection for the main loop
    
    // handle second endpoint
    xend = round(x2);
    yend = y2 + gradient * (xend - x2) / 256;
    xgap = fpart(x2 + 128);
    int xpxl2 = xend;  // this will be used in the main loop
    int ypxl2 = ipart(yend);
    plot(xpxl2, ypxl2, rfpart(yend) * xgap / 256);
    plot(xpxl2, ypxl2 + 256, fpart(yend) * xgap / 256);
    
    // main loop
    for (int x = xpxl1 + 1; x <= xpxl2 - 1; x += 256)
    {
        plot(x, ipart(intery), rfpart(intery));
        plot(x, ipart(intery) + 256, fpart(intery));
        intery = intery + gradient;
    }
}

/* Non-antialiased line drawing */

void drawline(int x1, int y1, int x2, int y2, int color, int dots)
{
    // Algorithm from here: http://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm#Simplification
    int dx = abs(x2 - x1);
    int dy = abs(y2 - y1);
    
    int sx = (x1 < x2) ? 1 : -1;
    int sy = (y1 < y2) ? 1 : -1;
    
    int err = dx - dy;
    int count = 0;
    for(;; count++)
    {
        if (!dots || (count >> (dots - 1)) & 1)
        {
            //__Point_SCR(x1, y1);
            //__LCD_SetPixl(color);
        }
        
        if (x1 == x2 && y1 == y2) break;
        
        int e2 = 2 * err;
        if (e2 > -dy)
        {
            err -= dy;
            x1 += sx;
        }
        else if (e2 < dx)
        {
            err += dx;
            y1 += sy;
        }
    }
}
</xmp>
</body>
</html>    