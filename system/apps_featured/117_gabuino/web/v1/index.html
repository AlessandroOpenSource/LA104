<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
    #my_html {
    position: absolute;
    top: 60px;
    right: 600px;
    bottom: 0;
    left: 0;
    }
    #my_control {
    position: absolute;
    top: 52px;
    right: 0px;
    bottom: 0;
    width: 600px;
    padding: 8px;
    }
    #my_html_hidden {
    display: none;
    }

    .ace_gutter-cell.ace_breakpoint{ 
        border-radius: 20px 0px 0px 20px; 
        background:#ff5555;
    }

    .errorHighlight{
      position:absolute;
      background-color:rgb(255, 55, 55, 0.2);
    }
    </style>

    <title>Gabuino</title>
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://rawgithub.com/ajaxorg/ace-builds/master/src/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://rawgithub.com/ajaxorg/ace-builds/master/src/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script src="compiler.js"></script>
    <script src="editor.js"></script>
    <script src="serial.js"></script>
    <script src="comm.js"></script>
    <script src="bios.js"></script>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <script src="binary-parser/context.js"></script>
    <script src="binary-parser/binary_parser.js"></script>
    <script src="parseelf.js"></script>
    <script src="examples.js"></script>
    <script src="debugger.js"></script>
    <script src="debugger2.js"></script>
<!--    <script src="symbols/ds213_os_bb9698a0.js"></script>
    <script src="symbols/ds213_gabuino.js"></script>-->

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#"><img src="gabuino.png" height=32></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Examples
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="_examples">
        </div>
      </li>

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          File
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          <a class="dropdown-item" href="#">Save</a>
          <a class="dropdown-item" href="#">Save as...</a>
          <a class="dropdown-item" href="#">Delete</a>
          <a class="dropdown-item" href="#">Download binary</a>
          <div class="dropdown-divider"></div>
          <a><h6 class="dropdown-header">Stored programs</h6></a>
          <a class="dropdown-item" href="#">User program 1</a>
          <a class="dropdown-item" href="#">User program 2</a>
        </div>
      </li>


      <button class="btn btn-sm btn-outline-secondary mr-2" type="button" id="_connect">Connected</button>
      <a class="navbar-text mr-2" id="_connectText">Device not found</a>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <button class="btn btn-outline-success mr-1 my-2 my-sm-0" type="button" id="_run">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play" viewBox="3 3 12 12">
  <path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>
</svg>
Run</button>

      <button class="btn btn-success mr-1 my-2 my-sm-0" type="button" id="_stop">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop" viewBox="3 3 12 12">
  <path d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z"/>
</svg>
Stop</button>
    </form>
  </div>
</nav>



<div id="my_control">

<div class="card">
<article class="card-body">
<h4 class="card-title mb-4 mt-1">Compilation</h4>
  <div class="form-group" id="_compilationText">
  </div>
</article>
</div>

<br>

<div class="card">
<article class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-4 mt-1">Console</h4>
        <div>
            <button type="button" class="btn btn-outline-success" onclick="screenshot()">Screenshot</button>
            <button type="button" class="btn btn-outline-success" onclick="clear()">Clear</button>
<!--            <button type="button" class="btn btn-outline-success">Pause</button>-->
        </div>
    </div>

  <div class="form-group" id="_debugText" style="white-space: pre-wrap; "></div>
</article>
</div>
<br>

<div class="card">
<article class="card-body">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="card-title mb-4 mt-1">Debug</h4>
    <div>
      <button type="button" class="btn btn-outline-success" onclick="dbgui.demo()">Start debug</button>
      <button type="button" class="btn btn-outline-success" onclick="dbgui.frame()">Inspect</button>
      <button type="button" class="btn btn-outline-success" onclick="a()">Resume break</button>
    </div>
  </div>

<div class="row">
    <div class="card col-5">
      <b>Variables</b>
      <pre id="variables"></pre>
    </div>

    <div class="card col-7">
      <b>Call stack</b>
      <pre id="callstack"></pre>
    </div>
</div>
<!--
  <input type=button id="frame" value="Start debugging" onclick="debug()">
  <input type=button id="frame" value="frame" onclick="frame()">
  <input type=button id="assembly" value="assembly" onclick="getAssembly()">
-->
</article>
<div id="_testing"></div>
</div>


</div>


<script>
var running = false;
$('#_connect').on('click', function(event) {
//  event.preventDefault(); // To prevent following the link (optional)
  COMM.doConnect();
});

$('#_run').on('click', function(event) {
  store_code();

  var newCode = html_editor.getValue();

  if (typeof(lastCode) != "undefined" && lastCode == newCode)
  {
    // reset bss!
    $("#_debugText").text("");
    run();
    return;
  }
  lastCode = newCode;
  lastAssembly = null;

  var tick0 = (new Date).getTime();
  var tick1, tick2, tick3;

  compile()
  .then( (elf) => {
    tick1 = (new Date).getTime();
    $("#_compilationText").text("Compilation took " + (tick1-tick0) + "ms.\n");  
    return elf;
  })
  .then( elf => processElf(elf))
  .then( (stats) => {
    tick2 = (new Date).getTime();
    $("#_compilationText").append("Processing took " + (tick2-tick1) + "ms.\n");  
    $("#_debugText").text("");
  })
  .then( () => resolveImports())
  .then( () => {
    tick3 = (new Date).getTime();
    $("#_compilationText").append("Resolving relocations took " + (tick3-tick2) + "ms.\n");  
    $("#_debugText").text("");
  })
  .then( () => flash() )
  .then( () =>
  {
    tick4 = (new Date).getTime();
    $("#_compilationText").append("Flashing took " + (tick4-tick3) + "ms.\n");  
    $("#_compilationText").append("Application size " + globalBlob.length + " bytes\n");  
    return run();
  })
  .catch( stderr =>
  {
    var errors = stderr.split("<stdin>:").join("");
//    errors = errors.split("\r").join("<br>");
    $("#_compilationText").html("Failed: <pre>"+errors+"</pre>");  
  });

});

$('#_stop').on('click', function(event) {
  stop();
});

COMM.setDisconnected = () => { 
  $("#_connect").text("Connect"); 
  $("#_connectText").text("Disconnected"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};
COMM.setConnected = () => { 
  $("#_connect").text("Disconnect"); 
  $("#_connectText").text("Connected"); 
  $("#_connect").removeClass("btn-secondary").addClass("btn-outline-secondary");
};
COMM.setConnecting = () => { 
  $("#_connect").text("Connecting..."); 
  $("#_connectText").text(""); 
  $("#_connect").removeClass("btn-secondary").addClass("btn-outline-secondary");
};
COMM.setConnectFailed = (err) => { 
  $("#_connect").text("Connect"); 
  $("#_connectText").text(err ? err : "Connection failed"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};
COMM.setNoDevices = () => {
  $("#_connect").text("Connect"); 
  $("#_connectText").text("Not connected"); 
  $("#_connect").removeClass("btn-outline-secondary").addClass("btn-secondary");
};

function _DBGPRINT(msg)
{
//document.getElementById("_debugText").innerHTML += msg;
  $("#_debugText").append(msg);
}

function _DBGEVENT(e, arg)
{
  switch (e)
  {
    case 1: running = false; console.log("Program finished"); break;
    case 2: console.log("Program trapped at 0x" + arg.toString(16)); break;
    default: console.log("Unrecognized event " + e);
  }
 
//  $("#_debugText").append();
}

function clear()
{
  $("#_debugText").html("");
}

for (var i in examples)
{
  $("#_examples").append('<a class="dropdown-item" href="#">'+i+'</a>');
}

var elements = $("#_examples").children("a"); //.dropdown-item");

for (var i=0; i<elements.length; i++)
{
  elements[i].addEventListener('click', (event) => {
    html_editor.setValue(examples[event.target.innerText])
//    alert(`Clicked ${event.target.innerText}!`);
  });
};

function store_code()
{
  var code = html_editor.getValue();
  window.localStorage.setItem("lastCode", code);
}

function load_code()
{
  var last = window.localStorage.getItem("lastCode");
  if (last)
    html_editor.setValue(last);
  else
    html_editor.setValue(`#include <library.h>

int main(void)
{
    while (!KEY::GetKey())
    {
        DBG::Print("Hello!");
        BIOS::SYS::DelayMs(250);
    }
    
    return 0;
}`);
   
}

function getAssembly()
{
  assembly().then( asm => $("#_testing").html("<pre>"+asm+"</pre>"));
}
document.addEventListener('DOMContentLoaded', () => load_code());



/////////
var dbg = new Debugger();
class DebuggerUi
{
  constructor(instance)
  {
    this.code = null;
    this.variables = [];
    this.instance = instance;
    this.offline = true;
  }

  demo()
  {
    this.setCode(html_editor.getValue());
    var stack = ['0x00000000', '0x08041b77 (ds213_gabuino) st_usbfs_poll', '0x08041b03 (ds213_gabuino) st_usbfs_poll', '0x42228198', '0x60000000', '0xfffffff9', '0x00000123', '0x00000000', '0x0000018f', '0x000000ef', '0x0800028d', '0x08008649 (ds213_os_bb9698a0) BIOS::LCD::PutPixel(int, int, unsigned short)', '0x080002ae', '0x69000000', '0x0000462c', '0x00000079', '0x00000000', '0x00000123', '0x2000525b', '0x000000c8', '0x00007900', '0x00012301', '0x200084b8', '0x20008498', '0x592e8480', '0x00007900', '0x20004780 (ds213_gabuino) MEMORY::userRetVal', '0x20008490', '0x2000552f', '0x00007b00', '0x00013100', '0x00006d00', '0x0000c800', '0x00000e00', '0x00006900', '0x200084ac', '0x20001524 (ds213_os_bb9698a0) Hw', '0x200084b4', '0x00000000', '0x200084c7', '0x200084c4', '0x20008500', '0x0073cdbd', '0x00007b00', '0x00013100', '0x00006d00', '0x0000c800', '0x00000080', '0x00007b00', '0x00013100', '0x00000022', '0x00012301', '0x00007938', '0x00000000', '0x00007b00', '0x20008508', '0x2000509b', '0x00003ecc', '0x00000000', '0x00000061', '0x00003ecc', '0x0000007b', '0x00000131', '0x00000001', '0x00000000', '0x0000006d', '0x000000c8', '0xfdffbd7c', '0x20004834 (ds213_gabuino) MEMORY::writeSum', '0x20008538', '0x200050f9', '0x20008540', '0x20005105', '0x20008548', '0x20005111', '0x20008550', '0x2000511d', '0x20008558', '0x20005009', '0x00007fe5', '0x08040751 (ds213_gabuino) MEMORY::Exec(unsigned long)', '0x08040725 (ds213_gabuino) MEMORY::Exec(unsigned long)', '0x00000000', '0x20004b1d', '0x08040bb1', '0x08041b03 (ds213_gabuino) st_usbfs_poll', '0x20004834 (ds213_gabuino) MEMORY::writeSum', '0x200049e0 (ds213_gabuino) command', '0x200049e0 (ds213_gabuino) command', '0x00000000'];
    stack = stack.map(f=>parseInt(f.substr(0,10)));
    this.decodeStack(stack)
      .then(() => this.fetchAndDecodeVariables());
  }

  frame()
  {
    this.offline = false;
    this.setCode(html_editor.getValue());

    // reset
    COMM._onReceive = COMM._defReceive;

    return BIOS.frame().then(f => {
      var arr = [];
      for (var i=0; i<f.length; i++) arr.push(f[i]); //"0x"+ ("00000000"+f[i].toString(16)).substr(-8));
      return arr;
    })
    .then((stack)=>this.decodeStack(stack))
    .then(() => this.fetchAndDecodeVariables());
  }

  setCode(code)
  {
    this.code = code;
  }

  decodeStack(stack)
  {
    return dbg.initialize(this.code)
    .then(() =>
      {
        var html = stack.map(p => dbg.decodeAddr(p))
          .filter(x => x)
          .filter(x => x.name.indexOf("st_usbfs_poll") == -1)
          .map(x => {
            if (x.line)
              return x.module + ": " + "<a href='#' onClick='"+this.instance+".jumpTo("+x.line+")'>" + x.name + "</a>"
            else
              return x.module + ": " + x.name + (x.offset ? " + " + x.offset : "");
          })
          .join("\n");

        $("#callstack").html(html)
      })
  }

  fetchAndDecodeVariables()
  {
    var requests = Promise.resolve();
    this.variables = dbg.getVariables();
    for (var i in this.variables)
      requests = requests.then( ((v) => this.requestVariableBuffer(v).then(d => v.buffer = d)).bind(this, this.variables[i]) );
//      requests = requests.then( ((v) => this.requestVariable(v, "")).bind(this, this.variables[i]) );

    return requests.then(this.decodeVariables.bind(this))
  }

  formatVariable(v)
  {
    var format = this.getVariableFormatter(v.name);

    var aux = v.buffer;
    if (format)
      aux = eval(format)(aux);

    aux = typeof(aux) == "object" ? JSON.stringify(aux) : aux;
//    aux = typeof(aux) == "object" ? aux.toString() : aux;
    return aux;
  }

  decodeVariables()
  {
    var html = this.variables.map(v => {
      var aux = this.formatVariable(v);
      return "<nobr>" +
        "<a href='#' onClick='"+this.instance+".setType(0x"+v.addr.toString(16)+")'>" + v.name + "</a> = " +
        "<a href='#' onClick='"+this.instance+".setValue(0x"+v.addr.toString(16)+")'>" + aux + "</a>" +
      "</nobr>"
    }).join("\n");
    $("#variables").html(html);
  }

  requestVariableBuffer(variable)
  {
    if (!this.offline)
    {
      return BIOS.memRead(variable.addr, variable.len);
    }
    
    return new Promise((resolve, reject) =>
    {
      console.log("Debug mode!");
      // debug mode!
      if (variable.name == "mojPoint")
        return resolve(new Uint8Array([0, 0, 0, 7, 0, 0, 0, 8]));
      if (variable.name == "mojString")
        return resolve(new TextEncoder().encode("xxx\x00"));
      if (variable.name == "mojaPremenna")
        return resolve(new Uint8Array([0, 0, 0, 0x20]));
      resolve(new Uint8Array([]))
    });
  }

  setVariableFormatter(name, format)
  {
    window.localStorage.setItem("formatter_"+name, format);
  }

  getVariableFormatter(name)
  {
    return window.localStorage.getItem("formatter_"+name);
  }

  setVariableBuffer(variable, buffer)
  {
    if (!this.offline)
    {
//      console.log(buffer);
      return BIOS.memWrite(variable.addr, buffer)
        .then(() => BIOS.memRead(variable.addr, variable.len))
        .then((buf) => variable.buffer = buf );
    }
    //  return Promise.reject();

    // shoud write and readback!
    console.log(buffer);
    variable.buffer = buffer;
  }

  jumpTo(line)
  {
    html_editor.gotoLine(line, 0, true);
    return false;
  }

  setValue(varptr)
  {
    var variable = this.variables.find(v => v.addr == varptr);
    var formatter = this.getVariableFormatter(variable.name);
    var value;

    if (formatter.indexOf("string") != -1)
      value = new Parser().string(null, {zeroTerminated:true}).parse(variable.buffer);
    else if (variable.len == 1)
      value = new Parser().uint8().parse(variable.buffer);
    else if (variable.len == 2)
      value = new Parser().uint16().parse(variable.buffer);
    else if (variable.len == 4)
      value = new Parser().uint32().parse(variable.buffer);
    else
      value = variable.buffer.toString(); 

    value = prompt("Enter new value for " + variable.name, value);
    if (value == null)
      return;

    var buffer = null;
    if (formatter.indexOf("string") != -1)
      buffer = new TextEncoder().encode(value + "\x00");
    else if (variable.len == 1)
      buffer = new Uint8Array([parseInt(value)]);
    else if (variable.len == 2)
      buffer = new Uint8Array([parseInt(value), parseInt(value)>>8]);
    else if (variable.len == 4)
      buffer = new Uint8Array([parseInt(value), parseInt(value)>>8, parseInt(value)>>16, parseInt(value)>>24]);
    else
      buffer = new Uint8Array(value.split(",").map(v=>parseInt(v,10)))

    if (!buffer)
      throw "Formatting failed";
    this.setVariableBuffer(variable, buffer)
      .then( ()=>this.decodeVariables() )
    return false;
  }

  setType(varptr)
  {
    var help = `Formatting help:
Structures: buf => JSON.stringify(new Parser().uint32("x").uint32("y").parse(buf))
Strings: buf => "\\\"" + new Parser().string(null, {zeroTerminated:true}).parse(buf) + "\\\""
Integers: buf => "0x" + new Parser().uint32().parse(buf).toString(16)
`;
    console.log(help);
    var variable = this.variables.find(v => v.addr == varptr);
    var newformat = prompt("Enter formating string for " + variable.name + " of size " + 
      variable.len + " at 0x" + ("00000000"+variable.addr.toString(16)).substr(-8),
      this.getVariableFormatter(variable.name));

    if (newformat)
    {
      this.setVariableFormatter(variable.name, newformat);
      this.decodeVariables();
    }
    return false;
  }
};

var dbgui = new DebuggerUi("dbgui");
/*
function demodebug_go(line)
{
  html_editor.gotoLine(line, 0, true);
  return false;
}

function variable_set_type(addr)
{
  return false;
}

function variable_set_value(addr)
{
  return false;
}
*/
</script>

<div id="my_html">
</div>

</body>
</html>    