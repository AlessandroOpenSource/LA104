<!--
TODO: Assertion
multi signal / multi histo
signal drag
 signal zoom
histo columns?
signal view align + sync

histogram delete element -> hide window
signal view - refresh scroll left
-->
<script src="https://cdn.jsdelivr.net/npm/rete@1.5.2/build/rete.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-vue-render-plugin@0.5.1/build/vue-render-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@0.9.0/build/connection-plugin.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/rete-lifecycle-plugin@1.0.0-beta.1/build/lifecycle-plugin.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/alight@0.14.1/alight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@0.2.1/build/area-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-context-menu-plugin@0.6.0/build/context-menu-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-comment-plugin@0.3.0/build/comment-plugin.min.js"></script>           	
<script src="https://cdn.jsdelivr.net/npm/rete-history-plugin@0.1.0/build/history-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-connection-mastery-plugin@0.1.0/build/connection-mastery-plugin.min.js"></script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="signal.js"></script>
<script src="signalcanvas.js"></script>
<script src="signalhistogram.js"></script>
<script src="vuecontrols.js"></script>
<script src="retecontrols.js"></script>
<script src="retecomponents.js"></script>

<style>
html, body {
  height: 100%;
  width: 100%;
  margin: 0;
  overflow: hidden;
}

.node .control input, .node .input-control input {
  width: 140px;
}
select, input {
  width: 100%;
  border-radius: 30px;
  background-color: white;
  padding: 2px 6px;
  border: 1px solid #999;
  font-size: 110%;
  width: 170px;
}

.note {
  position: absolute;
  top: 0;
  left: 0;
  background: #7ca2ba;
  color: white;
  width: 100%;
  text-align: center;
  padding: 0.5em;
  font-family: sans-serif;
  z-index: 1;
  a {
    color: #eee;
  }
}

#chart {
  width: 800px;
  height: 400px;
  position: absolute;
  left: 800px;
  top: 200px;
  border:3px #04b solid;
  border-radius:10px;
  display: none;
}

input:disabled { background: #ddd; color: #888}
</style>


<div id="rete"></div>
<div id="chart"></div>

<script>

var numSocket = new Rete.Socket('Number value');
var arrSocket = new Rete.Socket('Array value');
var attrSocket = new Rete.Socket('Attributes');



var onNewData;

(async () => {
    var container = document.querySelector('#rete');
    var components = [new InputSignal(), new SubArray(), new Quantize(),
      new Histogram(), new Filter(), new Split(), new Pairs(), new LookupTable(), new Print(), new ToInteger(), new If(),
      new Attributes(), new DisplaySignal(), new Assert(), new Count()];

    var getComponent = name => components.find(c=>c.constructor.name == name)
    var editor = new Rete.NodeEditor('demo@0.1.0', container);
    editor.use(ConnectionPlugin.default);
    editor.use(VueRenderPlugin.default);    
    editor.use(ContextMenuPlugin.default);
    editor.use(AreaPlugin);
    editor.use(CommentPlugin.default);
    editor.use(HistoryPlugin);
    editor.use(ConnectionMasteryPlugin.default);
    editor.use(LifecyclePlugin.default);

    var engine = new Rete.Engine('demo@0.1.0');
    
    components.map(c => {
      editor.register(c);
      engine.register(c);
    });

    var model = {
      // signal extraction
      input: {id:"InputSignal"},
      preamble: {id:"If"},
      subarray: {id:"SubArray"},
      filter: {id:"Split"},
      // signal conditioning
      quantize: {id:"Quantize"},
      // signal processing
      pairs: {id:"Pairs"},
      lut: {id:"LookupTable"},
      convert: {id:"ToInteger"},
      // result
      attributes: {id:"Attributes"},
      // debugging
      print: {id:"Print"},
      histogram: {id:"Histogram"},
      display: {id:"DisplaySignal"},
      assert: {id:"Assert"},
    }

    var connections = [ 
      ["input.out", "preamble.in"],
      ["input.out", "subarray.in"],
      ["preamble.out", "subarray._begin"],
      ["subarray.out", "filter.in"],
      ["filter.out", "quantize.in"],
      ["quantize.out", "pairs.in"],
      ["pairs.out", "lut.in"],
      ["lut.out", "convert.in"],
      ["convert.out", "attributes.in"],
      ["attributes.out", "print.in"],
      ["filter.out", "histogram.in"],
      ["filter.out", "display.in"],
      ["lut.out", "assert.in"],
    ]

    for (var i in model)
    {
      model[i].component = await getComponent(model[i].id).createNode() 
      model[i].data = model[i].component.data;
      if (model[i].id == "InputSignal")
        inputComponent = model[i].component;
    }

    model.preamble.data.condition = "arr[0] < 800 && arr[1] > 5000"
    model.preamble.data.retValues = ["3", "1"]
//    model.preamble.data.false = "1"
    model.subarray.data.tillEnd = true
    model.filter.data.condition = "x > 5000"
    model.filter.data.break = true;
    model.quantize.data.len = "300"
    model.lut.data.assign1 = ["300 600", "1"]
    model.lut.data.assign2 = ["600 300", "0"]
//    model.attributes.data.attribute1 = [?] TODO 
//    model.attributes.data.attribute2 = [?] TODO: Convert

    var i = 0;
    for (var m in model)
    {
      model[m].component.position = [100 + (i%4)*250, 200 + Math.floor(i/4)*280]
      editor.addNode(model[m].component);
      i++;
    }
    for (var c of connections)
    {
      var connOut = c[0].split(".");
      var connIn = c[1].split(".");
      var out = model[connOut[0]].component.outputs.get(connOut[1]);
      var inp = model[connIn[0]].component.inputs.get(connIn[1]);
      editor.connect(out, inp);      
    }

    editor.on('process nodecreated noderemoved connectioncreated connectionremoved', async () => {
      console.log('process');
        await engine.abort();
        await engine.process(editor.toJSON());
    });

    editor.on('zoom', (e) => {
        if (e.source === 'dblclick' && editor.selected?.list[0]?.name == "Input signal")
        {
          var node = editor.selected?.list[0];
          var _node = editor.nodes.find(n => n.id == node.id)
          var newsignal = prompt("Enter new signal", JSON.stringify(node.data.out.data));
          if (newsignal)
          {
            node.data.out = new Signal(JSON.parse(newsignal))
            editor.trigger('process');
          }
          return false;
        }
        return e.source !== 'dblclick';
    });

    onNewData = (data) => {
      for (var i in model)
      {
        if (model[i].id == "InputSignal")
        {
          var inp = model[i].component;
          inp.data.out = new Signal(data)
          editor.trigger('process');
          break;
        }
      }
    }

    editor.view.resize();
    //AreaPlugin.zoomAt(editor);
    editor.view.area.zoom(0.75, 0, -120);
    editor.trigger('process');
})();

window.document.addEventListener('SignalChanged', (e) => { 
  console.log("Got data", e.detail.data);
  onNewData(e.detail.data);
}, false);

</script>